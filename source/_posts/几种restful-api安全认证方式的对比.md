---
title: 几种restful api安全认证方式的对比
date: 2018-06-03 17:44:48
tags:
---


## API Key vs OAuth令牌 vs JWT

### API key

App key简称API接口验证序号，是用于验证API接入合法性的。接入哪个网站的API接口，就需要这个网站允许才能够接入，如果简单比喻的话：可以理解成是登陆网站的用户名 

App Secret简称API接口密钥，是跟App Key配套使用的，可以简单理解成是密码 
App Key 和 App Secret 配合在一起，通过其他网站的协议要求，就可以接入API接口调用或使用API提供的各种功能和数据。 
比如淘宝联盟的API接口，就是淘宝客网站开发的必要接入，淘客程序通过API接口直接对淘宝联盟的数据库调用近亿商品实时数据。做到了轻松维护，自动更新。


### OAuth令牌

OAuth令牌：非常适合访问用户数据  
OAuth是使用API​​访问用户数据的更好方式。与API密钥不同，OAuth不需要用户通过开发人员门户进行探索。事实上，在最好的情况下，用户只需单击一个按钮即可让应用程序访问其帐户。OAuth，特别是OAuth 2.0，是幕后流程的标准，用于确保安全处理这些权限。

此规范的先前版本OAuth 1.0和1.0a比OAuth 2.0复杂得多。最新版本中最大的变化是不再需要使用哈希值对每个调用进行签名。最常见的OAuth实现使用这些令牌中的一个或两个：

访问令牌：像API密钥一样发送，它允许应用程序访问用户的数据; 可选地，访问令牌可以到期。  
刷新令牌：可选地，是OAuth流的一部分，刷新令牌如果已过期则检索新的访问令牌。
与API密钥类似，您可以在很多地方找到OAuth访问令牌：查询字符串，标题和其他位置。由于访问令牌就像一种特殊类型的API密钥，因此最有可能放置它的是授权头，如下所示：  
Authorization: Bearer 1234567890abcdef  

访问和刷新令牌不应与客户端ID和客户端密钥混淆。这些值可能看起来像一个类似的随机字符集，用于协商访问和刷新令牌。

与API密钥一样，任何拥有访问令牌的人都可能会调用有害操作，例如删除数据。但是，OAuth对API密钥提供了一些改进。对于初学者来说，访问令牌可以绑定到特定的范围，这限制了应用程序可以访问的操作类型和数据。此外，与刷新令牌相结合，访问令牌将过期，因此负面影响可能会产生有限的影响。最后，即使不使用刷新令牌，仍然可以撤销访问令牌。






### 什么是JWT


起源:
说起JWT，我们应该来谈一谈基于token的认证和传统的session认证的区别。

传统的session认证

我们知道，http协议本身是一种无状态的协议，而这就意味着如果用户向我们的应用提供了用户名和密码来进行用户认证，那么下一次请求时，用户还要再一次进行用户认证才行，因为根据http协议，我们并不能知道是哪个用户发出的请求，所以为了让我们的应用能识别是哪个用户发出的请求，我们只能在服务器存储一份用户登录的信息，这份登录信息会在响应时传递给浏览器，告诉其保存为cookie,以便下次请求时发送给我们的应用，这样我们的应用就能识别请求来自哪个用户了,这就是传统的基于session认证。

但是这种基于session的认证使应用本身很难得到扩展，随着不同客户端用户的增加，独立的服务器已无法承载更多的用户，而这时候基于session认证应用的问题就会暴露出来.

基于session认证所显露的问题

Session: 每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，通常而言session都是保存在内存中，而随着认证用户的增多，服务端的开销会明显增大。

扩展性: 用户认证之后，服务端做认证记录，如果认证的记录被保存在内存中的话，这意味着用户下次请求还必须要请求在**这台**服务器上,这样才能拿到授权的资源，这样在**分布式**的应用上，相应的限制了负载均衡器的能力。这也意味着限制了应用的扩展能力。

CSRF: 因为是基于cookie来进行用户识别的, cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。

基于token的鉴权机制

基于token的鉴权机制类似于http协议也是无状态的，它不需要在服务端去保留用户的认证信息或者会话信息。这就意味着基于token认证机制的应用不需要去考虑用户在哪一台服务器登录了，这就为应用的扩展提供了便利。

流程上是这样的：  
1.用户使用用户名密码来请求服务器  
2.服务器进行验证用户的信息  
3.服务器通过验证发送给用户一个token  
4.客户端存储token，并在每次请求时附送上这个token值  
5.服务端验证token值，并返回数据

这个token必须要在每次请求时传递给服务端，它应该保存在请求头里， 另外，服务端要支持CORS(跨来源资源共享)策略，一般我们在服务端这么做就可以了Access-Control-Allow-Origin: *。

那么我们现在回到JWT的主题上。  
JWT长什么样？  
JWT是由三段信息构成的，将这三段信息文本用.链接一起就构成了Jwt字符串。就像这样:  
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
```

JWT的构成  
第一部分我们称它为头部（header),第二部分我们称其为载荷（payload, 类似于飞机上承载的物品)，第三部分是签证（signature).

header  
jwt的头部承载两部分信息：

声明类型，这里是jwt
声明加密的算法 通常直接使用 HMAC SHA256
完整的头部就像下面这样的JSON：

```
{
  'typ': 'JWT',
  'alg': 'HS256'
}
```

然后将头部进行base64加密（该加密是可以对称解密的),构成了第一部分.
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9
```

playload  
载荷就是存放有效信息的地方。这个名字像是特指飞机上承载的货品，这些有效信息包含三个部分：标准中注册的声明、公共的声明、私有的声明

标准中注册的声明 (建议但不强制使用) :  
iss: jwt签发者  
sub: jwt所面向的用户  
aud: 接收jwt的一方  
exp: jwt的过期时间，这个过期时间必须要大于签发时间  
nbf: 定义在什么时间之前，该jwt都是不可用的.  
iat: jwt的签发时间  
jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。    
公共的声明:  
公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.

私有的声明 ：  
私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。

定义一个payload:  
```
{
  "sub": "1234567890",
  "name": "John Doe",
  "admin": true
}
```
然后将其进行base64加密，得到Jwt的第二部分。

signature   
jwt的第三部分是一个签证信息，这个签证信息由三部分组成：  
1.header (base64后的)  
2.payload (base64后的)  
3.secret  
这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。

注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。


### 总结  
优点：  
1.因为json的通用性，所以JWT是可以进行跨语言支持的，像JAVA,JavaScript,NodeJS,PHP等很多语言都可以使用。  
2.因为有了payload部分，所以JWT可以在自身存储一些其他业务逻辑所必要的非敏感信息。  
3.便于传输，jwt的构成非常简单，字节占用很小，所以它是非常便于传输的。  
4.它不需要在服务端保存会话信息, 所以它易于应用的扩展  
安全相关    
不应该在jwt的payload部分存放敏感信息，因为该部分是客户端可解密的部分。
保护好secret私钥，该私钥非常重要。
如果可以，请使用https协议


## 应该使用哪种？
如您所见，这三个选项并不相互排斥。事实上，有些API可以同时使用这三种。或者每个都可以独立使用。

如果您希望开发人员构建不需要访问多个用户数据的内部应用程序，请使用API​​密钥。
如果您希望用户轻松地为应用程序提供授权而无需共享私有数据或挖掘开发人员文档，请使用OAuth访问令牌。
如果要限制数据库查找并且不需要立即撤消访问权限，请将JWT与OAuth配合使用。
注意：保持API密钥简单性同时还支持OAuth的一种方法是创建一次性令牌以供内部使用。
tails/81170785